<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ç™½å…­å³æ™‚åŒ¯ç‡è¨ˆç®—æ©Ÿ - Skin å‡ç´šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; -webkit-text-size-adjust:100%; margin:0; transition: background 0.5s; }
        .calc-button { padding:1rem 0.5rem; font-size:16px; font-weight:700; transition:all .1s; cursor:pointer; -webkit-tap-highlight-color:transparent; touch-action:manipulation; user-select:none; border:none; }
        .calc-button:active { transform:scale(.95); filter: brightness(0.9); }
        .calculator-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
        .currency-selector-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
        .modal-currency-grid { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; }
        .currency-modal-inner { max-height:40vh; overflow-y:auto; padding-right:6px; }
        
        /* å¤–çš®æ¨£å¼å®šç¾© */
        #app { transition: all 0.5s ease; position: relative; overflow: hidden; }
        
        /* 1. é è¨­æ¨£å¼ */
        .skin-default { background: white; color: #1f2937; }
        .skin-default .display-area { background: #f3f4f6; }

        /* 2. å®¢å®¶èŠ±ç´‹ - åƒè€ƒè—è¡«èˆ‡ç¢èŠ± */
        .skin-hakka { 
            background: #003399; /* æ·±é›è— */
            background-image: radial-gradient(#ffffff 10%, transparent 10%), radial-gradient(#ff69b4 10%, transparent 10%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            color: white; 
        }
        .skin-hakka h1 { color: #fff; text-shadow: 1px 1px 2px #000; }
        .skin-hakka .display-area { background: rgba(255,255,255,0.9); border: 2px solid #ff69b4; }

        /* 3. æ¢µè°·æ˜Ÿå¤œ - æµå‹•æ„Ÿèˆ‡é‡‘é»ƒ */
        .skin-starry { 
            background: linear-gradient(135deg, #121E3E 0%, #283E51 50%, #4B79A1 100%);
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            color: white; 
        }
        .skin-starry .display-area { background: rgba(18, 30, 62, 0.8); border: 1px solid #fde047; }
        .skin-starry .calc-button.bg-gray-50 { background: #fde047; color: #1e3a8a; }
        .skin-starry .calc-button.bg-yellow-500 { background: #ca8a04; }

        /* å·¥å…· */
        .display-area { padding: 1rem; border-radius: 0.5rem; transition: all 0.3s; }
        .btn-rounded { border-radius:.5rem; }
        .locked { background:linear-gradient(90deg,#ecfdf5,#d1fae5); border:2px solid #10b981; color:#065f46; cursor:default; }
        .animate-pulse { animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%{opacity:1}50%{opacity:.6}100%{opacity:1} }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

  <div id="app" class="w-full max-w-sm shadow-2xl rounded-2xl p-5 md:p-6 skin-default">
    <header class="mb-4 text-center">
      <h1 class="text-2xl font-bold">ğ“ƒ¥ç™½å…­åŒ¯ç‡è¨ˆç®—</h1>
      <p id="update-status" class="text-xs opacity-70 mt-1">åŒ¯ç‡è³‡æ–™: è¼‰å…¥ä¸­...</p>
    </header>

    <div class="display-area mb-6 shadow-inner">
      <div id="display-expression" class="text-right h-6 overflow-hidden whitespace-nowrap mb-1 text-sm opacity-80"></div>
      <div class="flex justify-between items-end">
        <div id="display-currency-flag" class="mr-2 text-lg font-bold"></div>
        <div id="display-value" class="text-right overflow-hidden whitespace-nowrap font-mono text-3xl font-black">0</div>
      </div>
    </div>

    <div id="currency-selectors" class="currency-selector-grid mb-6"></div>

    <div class="calculator-grid">
      <button onclick="handleMemory('clear')" class="calc-button btn-rounded bg-gray-200 text-gray-700 shadow-sm">MC</button>
      <button onclick="handleMemory('recall')" class="calc-button btn-rounded bg-gray-200 text-gray-700 shadow-sm">MR</button>
      <button onclick="handleMemory('add')" class="calc-button btn-rounded bg-gray-200 text-gray-700 shadow-sm">M+</button>
      <button onclick="handleMemory('subtract')" class="calc-button btn-rounded bg-gray-200 text-gray-700 shadow-sm">M-</button>

      <button onclick="handleInput('C')" class="calc-button btn-rounded bg-red-500 text-white shadow-sm">C</button>
      <button onclick="handleInput('âŒ«')" class="calc-button btn-rounded bg-gray-300 text-gray-800 shadow-sm">âŒ«</button>
      <button onclick="toggleModal()" class="calc-button btn-rounded bg-indigo-600 text-white shadow-sm">âš™ï¸</button>
      <button onclick="handleInput('/')" class="calc-button btn-rounded bg-yellow-500 text-white shadow-sm">Ã·</button>

      <button onclick="handleInput('7')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">7</button>
      <button onclick="handleInput('8')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">8</button>
      <button onclick="handleInput('9')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">9</button>
      <button onclick="handleInput('*')" class="calc-button btn-rounded bg-yellow-500 text-white shadow-sm">Ã—</button>

      <button onclick="handleInput('4')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">4</button>
      <button onclick="handleInput('5')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">5</button>
      <button onclick="handleInput('6')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">6</button>
      <button onclick="handleInput('-')" class="calc-button btn-rounded bg-yellow-500 text-white shadow-sm">ï¼</button>

      <button onclick="handleInput('1')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">1</button>
      <button onclick="handleInput('2')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">2</button>
      <button onclick="handleInput('3')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">3</button>
      <button onclick="handleInput('+')" class="calc-button btn-rounded bg-yellow-500 text-white shadow-sm">ï¼‹</button>

      <button onclick="handleInput('0')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">0</button>
      <button onclick="handleInput('.')" class="calc-button btn-rounded bg-gray-50 text-gray-900 shadow-sm">.</button>
      <button onclick="handleInput('+/-')" class="calc-button btn-rounded bg-gray-300 text-gray-800 shadow-sm">Â±</button>
      <button onclick="calculate()" class="calc-button btn-rounded bg-green-500 text-white shadow-sm">=</button>
    </div>
  </div>

  <div id="currency-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 relative text-gray-800">
      <h2 class="text-xl font-bold mb-4 border-b pb-2">âš™ï¸ è¨­å®šèˆ‡å€‹æ€§åŒ–</h2>
      
      <div class="mb-6">
        <label class="block text-sm font-bold text-gray-700 mb-2">è¨ˆç®—æ©Ÿå¤–çš®é¸æ“‡ï¼š</label>
        <div class="flex gap-2">
            <button onclick="changeSkin('default')" class="flex-1 py-2 rounded border border-gray-300 bg-white text-gray-800 text-xs font-bold">é è¨­ç™½</button>
            <button onclick="changeSkin('hakka')" class="flex-1 py-2 rounded border border-blue-800 bg-blue-700 text-white text-xs font-bold">å®¢å®¶èŠ±ç´‹</button>
            <button onclick="changeSkin('starry')" class="flex-1 py-2 rounded border border-indigo-900 bg-indigo-900 text-yellow-400 text-xs font-bold">æ¢µè°·æ˜Ÿå¤œ</button>
        </div>
      </div>

      <label class="block text-sm font-bold text-gray-700 mb-2">æ›¿æ›å¸¸ç”¨è²¨å¹£ï¼š</label>
      <div class="currency-modal-inner mb-4">
        <div id="modal-currency-list" class="modal-currency-grid"></div>
      </div>

      <button onclick="closeModal()" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg">
        å®Œæˆ
      </button>
    </div>
  </div>

  <script>
    // æ¨£å¼æ¨¡çµ„
    function changeSkin(skinName) {
        const app = document.getElementById('app');
        app.classList.remove('skin-default', 'skin-hakka', 'skin-starry');
        app.classList.add(`skin-${skinName}`);
        localStorage.setItem('user-skin', skinName);
        toast(`å·²è®Šæ›å¤–çš®ï¼š${skinName}`);
    }

    // å…¨å±€ç‹€æ…‹
    let expression = '';
    let lastValue = 0;
    let currentCurrency = 'TWD';
    let exchangeRates = {};
    let memoryValue = 0;
    let currencyToReplace = null;

    const FLAGS = {
      "TWD":"ğŸ‡¹ğŸ‡¼ TWD","USD":"ğŸ‡ºğŸ‡¸ USD","JPY":"ğŸ‡¯ğŸ‡µ JPY","EUR":"ğŸ‡ªğŸ‡º EUR","CNY":"ğŸ‡¨ğŸ‡³ CNY",
      "HKD":"ğŸ‡­ğŸ‡° HKD","GBP":"ğŸ‡¬ğŸ‡§ GBP","AUD":"ğŸ‡¦ğŸ‡º AUD","SGD":"ğŸ‡¸ğŸ‡¬ SGD","KRW":"ğŸ‡°ğŸ‡· KRW",
      "CAD":"ğŸ‡¨ğŸ‡¦ CAD","CHF":"ğŸ‡¨ğŸ‡­ CHF","ZAR":"ğŸ‡¿ğŸ‡¦ ZAR","SEK":"ğŸ‡¸ğŸ‡ª SEK","NZD":"ğŸ‡³ğŸ‡¿ NZD",
      "THB":"ğŸ‡¹ğŸ‡­ THB","PHP":"ğŸ‡µğŸ‡­ PHP","IDR":"ğŸ‡®ğŸ‡© IDR","MYR":"ğŸ‡²ğŸ‡¾ MYR","INR":"ğŸ‡®ğŸ‡³ INR",
      "VND":"ğŸ‡»ğŸ‡³ VND"
    };
    const ALL_CURRENCY_CODES = Object.keys(FLAGS);
    let DEFAULT_CURRENCIES = ['TWD','JPY','USD','EUR','CNY'];

    const displayExpr = document.getElementById('display-expression');
    const displayValue = document.getElementById('display-value');
    const displayFlag = document.getElementById('display-currency-flag');
    const updateStatus = document.getElementById('update-status');
    const currencySelectors = document.getElementById('currency-selectors');
    const currencyModal = document.getElementById('currency-modal');
    const modalCurrencyList = document.getElementById('modal-currency-list');

    async function fetchRates(){
      const API_URL = 'https://open.er-api.com/v6/latest/TWD';
      try{
        const res = await fetch(API_URL);
        const data = await res.json();
        const convertedRates = {"TWD":1.0};
        for(const [code,rate] of Object.entries(data.rates)){
          convertedRates[code] = 1 / rate;
        }
        exchangeRates = convertedRates;
        updateStatus.textContent = `åŒ¯ç‡æ›´æ–°æ–¼: ${new Date().toLocaleTimeString()}`;
        renderCurrencySelectors();
        updateDisplay();
      }catch(e){
        updateStatus.textContent = 'åŒ¯ç‡è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
      }
    }

    function renderCurrencySelectors(){
      currencySelectors.innerHTML = '';
      DEFAULT_CURRENCIES.forEach((code)=>{
        const isActive = code === currentCurrency;
        const button = document.createElement('button');
        button.textContent = code;
        button.className = `p-2 rounded-lg font-bold text-xs transition ${isActive ? 'bg-indigo-500 text-white scale-110 shadow-lg' : 'bg-black bg-opacity-10 hover:bg-opacity-20'}`;
        button.onclick = ()=> changeCurrency(code);
        currencySelectors.appendChild(button);
      });
    }

    function renderModalCurrencies(){
      modalCurrencyList.innerHTML = '';
      ALL_CURRENCY_CODES.forEach(code=>{
        const isSelected = DEFAULT_CURRENCIES.includes(code);
        const isToReplace = currencyToReplace === code;
        const div = document.createElement('div');
        div.className = `p-2 border rounded text-center cursor-pointer text-sm ${isSelected ? 'bg-blue-100 border-blue-500' : 'bg-gray-50'} ${isToReplace ? 'animate-pulse border-red-500 bg-red-50' : ''}`;
        div.innerHTML = `<div>${FLAGS[code].split(' ')[0]}</div><div class='font-bold'>${code}</div>`;
        div.onclick = () => handleModalSelection(code);
        modalCurrencyList.appendChild(div);
      });
    }

    function handleModalSelection(code){
      if(code === 'TWD') { toast('TWD ç‚ºåŸºæº–å¹£ä¸å¯æ›¿æ›'); return; }
      if(currencyToReplace){
          const idx = DEFAULT_CURRENCIES.indexOf(currencyToReplace);
          if(idx !== -1) {
              DEFAULT_CURRENCIES[idx] = code;
              currencyToReplace = null;
              renderModalCurrencies();
              renderCurrencySelectors();
              toast(`å·²æ›´æ–°å¸¸ç”¨è²¨å¹£ç‚º ${code}`);
          }
      } else if(DEFAULT_CURRENCIES.includes(code)) {
          currencyToReplace = code;
          toast('è«‹é»é¸ä¸‹æ–¹ä¸€å€‹æ–°å¹£åˆ¥ä¾†æ›¿æ›');
          renderModalCurrencies();
      }
    }

    function changeCurrency(newCurrency){
      if(newCurrency === currentCurrency) return;
      calculate(true);
      const prevRate = exchangeRates[currentCurrency] || 1;
      const newRate = exchangeRates[newCurrency] || 1;
      const valInTwd = lastValue * prevRate;
      lastValue = valInTwd / newRate;
      expression = String(lastValue);
      currentCurrency = newCurrency;
      renderCurrencySelectors();
      updateDisplay();
    }

    function handleInput(input){
      if(input==='C'){ expression=''; lastValue=0; }
      else if(input==='âŒ«') expression = expression.slice(0,-1);
      else if(input==='+/-') { calculate(true); lastValue = -lastValue; expression = String(lastValue); }
      else { expression += input; }
      calculate(false);
      updateDisplay();
    }

    function calculate(updateExpression=true){
      try{
        if(!expression) return;
        const result = new Function('return ' + expression.replace(/[^-()\d/*+.]/g,''))();
        if(isFinite(result)){
            lastValue = result;
            if(updateExpression) expression = String(result);
        }
      }catch(e){}
    }

    function handleMemory(action){
      calculate(true);
      const currentTwd = lastValue * (exchangeRates[currentCurrency] || 1);
      if(action==='add') memoryValue += currentTwd;
      else if(action==='subtract') memoryValue -= currentTwd;
      else if(action==='clear') memoryValue = 0;
      else if(action==='recall') {
          lastValue = memoryValue / (exchangeRates[currentCurrency] || 1);
          expression = String(lastValue);
      }
      toast('è¨˜æ†¶é«”å·²æ›´æ–°');
      updateDisplay();
    }

    function updateDisplay(){
      displayExpr.textContent = expression;
      displayValue.textContent = Number(lastValue).toLocaleString(undefined, {maximumFractionDigits: 4});
      displayFlag.textContent = FLAGS[currentCurrency] || currentCurrency;
    }

    function toggleModal(){ currencyModal.classList.toggle('hidden'); renderModalCurrencies(); }
    function closeModal(){ currencyModal.classList.add('hidden'); }
    
    function toast(msg){
        const t = document.createElement('div');
        t.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-[100] opacity-0 transition-opacity";
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>t.style.opacity="1", 10);
        setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(), 500); }, 2000);
    }

    window.onload = () => {
        fetchRates();
        const savedSkin = localStorage.getItem('user-skin') || 'default';
        changeSkin(savedSkin);
    };
  </script>
</body>
</html>
