<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ç™½å…­åŒ¯ç‡è¨ˆç®—æ©Ÿ - è—è¡“å¤–çš®ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent-color: #6366f1; }
        body { font-family: 'Inter', sans-serif; transition: all 0.5s ease; margin:0; height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #f0f2f5; overflow: hidden; }
        
        /* å…¨è¢å¹•èƒŒæ™¯å®¹å™¨ */
        .bg-layer { position: fixed; top:0; left:0; width:100%; height:100%; z-index: -1; transition: all 0.8s ease; background-size: cover; background-position: center; filter: brightness(0.8); }

        /* å¤–çš®é¡åˆ¥å®šç¾© */
        .skin-default-bg { background-color: #f0f2f5; }
        .skin-hakka-bg { background-image: url('./skin-hakka.jpg'); }
        .skin-starry-bg { background-image: url('./skin-starry.jpg'); }

        /* æ¯›ç»ç’ƒè¨ˆç®—æ©Ÿæœ¬é«” */
        #app { 
            width: 100%; max-width: 380px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 2.5rem;
            padding: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            transition: all 0.4s ease;
        }

        /* é¡¯ç¤ºå€è¨­è¨ˆ */
        .display-area { 
            background: rgba(255, 255, 255, 0.85);
            border-radius: 1.5rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            text-align: right;
        }

        /* æŒ‰éµæ¨£å¼ */
        .calc-button { 
            padding: 1.1rem 0; font-size: 1.2rem; font-weight: 700; border-radius: 1rem; 
            transition: all 0.1s ease; user-select: none;
        }
        .calc-button:active { transform: scale(0.92); filter: brightness(0.9); }
        
        /* é‡å°ä¸åŒå¤–çš®å¾®èª¿è¨ˆç®—æ©Ÿè‰²èª¿ */
        .skin-starry #app { background: rgba(18, 30, 62, 0.4); border-color: rgba(253, 224, 71, 0.2); }
        .skin-starry .display-area { background: rgba(255, 255, 255, 0.9); }
        .skin-starry h1 { color: #fde047; text-shadow: 0 0 10px rgba(0,0,0,0.5); }

        .skin-hakka #app { background: rgba(0, 51, 153, 0.2); border-color: rgba(255,255,255,0.3); }
        .skin-hakka h1 { color: #ffffff; }

        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .currency-selector-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 1rem; }
    </style>
</head>
<body>

  <div id="bg-layer" class="bg-layer skin-default-bg"></div>

  <div id="app">
    <header class="mb-4 text-center">
        <h1 class="text-2xl font-black italic tracking-tighter transition-colors duration-500">BAILIU CALC</h1>
        <p id="update-status" class="text-[9px] opacity-60 font-bold uppercase tracking-[0.2em] mt-1 text-gray-500">Live Rates Connecting...</p>
    </header>

    <div class="display-area">
        <div id="display-expression" class="h-5 text-gray-400 text-xs font-mono mb-1 truncate"></div>
        <div class="flex justify-between items-center">
            <div id="display-currency-flag" class="text-xl">ğŸ‡¹ğŸ‡¼</div>
            <div id="display-value" class="text-3xl font-black font-mono text-gray-800 truncate">0</div>
        </div>
    </div>

    <div id="currency-selectors" class="currency-selector-grid"></div>

    <div class="calculator-grid">
        <button onclick="handleMemory('clear')" class="calc-button bg-white/40 text-gray-700">MC</button>
        <button onclick="handleMemory('recall')" class="calc-button bg-white/40 text-gray-700">MR</button>
        <button onclick="handleMemory('add')" class="calc-button bg-white/40 text-gray-700">M+</button>
        <button onclick="handleMemory('subtract')" class="calc-button bg-white/40 text-gray-700">M-</button>

        <button onclick="handleInput('C')" class="calc-button bg-red-500 text-white shadow-lg">C</button>
        <button onclick="handleInput('âŒ«')" class="calc-button bg-gray-400/80 text-white">âŒ«</button>
        <button onclick="toggleModal()" class="calc-button bg-indigo-600 text-white shadow-lg">âš™ï¸</button>
        <button onclick="handleInput('/')" class="calc-button bg-amber-500 text-white">Ã·</button>

        <button onclick="handleInput('7')" class="calc-button bg-white/80 text-gray-800 shadow-sm">7</button>
        <button onclick="handleInput('8')" class="calc-button bg-white/80 text-gray-800 shadow-sm">8</button>
        <button onclick="handleInput('9')" class="calc-button bg-white/80 text-gray-800 shadow-sm">9</button>
        <button onclick="handleInput('*')" class="calc-button bg-amber-500 text-white">Ã—</button>

        <button onclick="handleInput('4')" class="calc-button bg-white/80 text-gray-800 shadow-sm">4</button>
        <button onclick="handleInput('5')" class="calc-button bg-white/80 text-gray-800 shadow-sm">5</button>
        <button onclick="handleInput('6')" class="calc-button bg-white/80 text-gray-800 shadow-sm">6</button>
        <button onclick="handleInput('-')" class="calc-button bg-amber-500 text-white">-</button>

        <button onclick="handleInput('1')" class="calc-button bg-white/80 text-gray-800 shadow-sm">1</button>
        <button onclick="handleInput('2')" class="calc-button bg-white/80 text-gray-800 shadow-sm">2</button>
        <button onclick="handleInput('3')" class="calc-button bg-white/80 text-gray-800 shadow-sm">3</button>
        <button onclick="handleInput('+')" class="calc-button bg-amber-500 text-white">+</button>

        <button onclick="handleInput('0')" class="calc-button bg-white/80 text-gray-800 shadow-sm">0</button>
        <button onclick="handleInput('.')" class="calc-button bg-white/80 text-gray-800 shadow-sm">.</button>
        <button onclick="handleInput('+/-')" class="calc-button bg-gray-400/80 text-white">Â±</button>
        <button onclick="calculate()" class="calc-button bg-emerald-500 text-white">=</button>
    </div>
  </div>

  <div id="currency-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-6 overflow-hidden">
      <h2 class="text-xl font-black mb-4 border-b pb-2 italic">SETTINGS</h2>
      
      <div class="mb-6">
        <p class="text-[10px] font-bold text-gray-400 mb-3 uppercase tracking-widest">Select Visual Skin</p>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="changeSkin('default')" class="py-2 text-xs font-bold rounded-xl border-2 border-gray-100 hover:border-indigo-500 transition bg-gray-50">Minimal</button>
            <button onclick="changeSkin('hakka')" class="py-2 text-xs font-bold rounded-xl border-2 border-blue-900 bg-blue-50 text-blue-900">å®¢å®¶èŠ±ç´‹</button>
            <button onclick="changeSkin('starry')" class="py-2 text-xs font-bold rounded-xl border-2 border-yellow-500 bg-indigo-900 text-yellow-400">æ¢µè°·æ˜Ÿå¤œ</button>
        </div>
      </div>

      <p class="text-[10px] font-bold text-gray-400 mb-3 uppercase tracking-widest">Exchange Rates</p>
      <div id="modal-currency-list" class="grid grid-cols-3 gap-2 max-h-[25vh] overflow-y-auto pr-1"></div>

      <button onclick="closeModal()" class="mt-6 w-full py-4 bg-black text-white font-black rounded-2xl hover:bg-gray-800 transition">
        DONE
      </button>
    </div>
  </div>

  <script>
    let expression = '';
    let lastValue = 0;
    let currentCurrency = 'TWD';
    let exchangeRates = {};
    let memoryValue = 0;
    let DEFAULT_CURRENCIES = ['TWD','JPY','USD','EUR','CNY'];
    const FLAGS = {"TWD":"ğŸ‡¹ğŸ‡¼ TWD","USD":"ğŸ‡ºğŸ‡¸ USD","JPY":"ğŸ‡¯ğŸ‡µ JPY","EUR":"ğŸ‡ªğŸ‡º EUR","CNY":"ğŸ‡¨ğŸ‡³ CNY","HKD":"ğŸ‡­ğŸ‡° HKD","GBP":"ğŸ‡¬ğŸ‡§ GBP","AUD":"ğŸ‡¦ğŸ‡º AUD","SGD":"ğŸ‡¸ğŸ‡¬ SGD","KRW":"ğŸ‡°ğŸ‡· KRW","VND":"ğŸ‡»ğŸ‡³ VND","THB":"ğŸ‡¹ğŸ‡­ THB"};

    // --- å¤–çš®åˆ‡æ›åŠŸèƒ½ ---
    function changeSkin(skinName) {
        const bg = document.getElementById('bg-layer');
        const app = document.getElementById('app');
        
        // åˆ‡æ›èƒŒæ™¯åœ–
        bg.className = `bg-layer skin-${skinName}-bg`;
        // åˆ‡æ›æœ¬é«”æ¨£å¼
        app.parentElement.className = `skin-${skinName}`; 
        document.body.className = `skin-${skinName}`;

        localStorage.setItem('user-skin-choice', skinName);
        toast(`Applied: ${skinName}`);
    }

    // --- åŒ¯ç‡èˆ‡è¨ˆç®— (æ ¸å¿ƒé‚è¼¯) ---
    async function fetchRates(){
      try{
        const res = await fetch('https://open.er-api.com/v6/latest/TWD');
        const data = await res.json();
        const converted = {"TWD":1.0};
        for(const [code,rate] of Object.entries(data.rates)) converted[code] = 1 / rate;
        exchangeRates = converted;
        document.getElementById('update-status').textContent = `Live: ${new Date().toLocaleTimeString()}`;
        renderCurrencySelectors();
        updateDisplay();
      }catch(e){ document.getElementById('update-status').textContent = 'Rates Offline'; }
    }

    function updateDisplay(){
      document.getElementById('display-expression').textContent = expression;
      document.getElementById('display-value').textContent = Number(lastValue).toLocaleString(undefined, {maximumFractionDigits: 4});
      document.getElementById('display-currency-flag').textContent = FLAGS[currentCurrency]?.split(' ')[0] || '';
    }

    function handleInput(input){
      if(input==='C'){ expression=''; lastValue=0; }
      else if(input==='âŒ«') expression = expression.slice(0,-1);
      else if(input==='+/-') { calculate(true); lastValue = -lastValue; expression = String(lastValue); }
      else { expression += input; }
      calculate(false);
      updateDisplay();
    }

    function calculate(updateExpression=true){
      try {
        if(!expression) return;
        const result = eval(expression.replace(/[^-()\d/*+.]/g,''));
        if(isFinite(result)){
            lastValue = result;
            if(updateExpression) expression = String(result);
        }
      } catch(e){}
    }

    function changeCurrency(newCurrency){
      if(newCurrency === currentCurrency) return;
      calculate(true);
      const valInTwd = lastValue * (exchangeRates[currentCurrency] || 1);
      lastValue = valInTwd / (exchangeRates[newCurrency] || 1);
      expression = String(lastValue);
      currentCurrency = newCurrency;
      renderCurrencySelectors();
      updateDisplay();
    }

    function renderCurrencySelectors(){
      const container = document.getElementById('currency-selectors');
      container.innerHTML = '';
      DEFAULT_CURRENCIES.forEach(code => {
        const active = code === currentCurrency;
        const btn = document.createElement('button');
        btn.textContent = code;
        btn.className = `py-2 text-[10px] font-black rounded-lg transition-all ${active ? 'bg-indigo-600 text-white scale-105 shadow-md' : 'bg-white/50 text-gray-600 hover:bg-white'}`;
        btn.onclick = () => changeCurrency(code);
        container.appendChild(btn);
      });
    }

    function toggleModal(){ 
        document.getElementById('currency-modal').classList.toggle('hidden'); 
        renderModalCurrencies(); 
    }
    function closeModal(){ document.getElementById('currency-modal').classList.add('hidden'); }
    
    function renderModalCurrencies(){
      const list = document.getElementById('modal-currency-list');
      list.innerHTML = '';
      Object.keys(FLAGS).forEach(code => {
        const isSelected = DEFAULT_CURRENCIES.includes(code);
        const div = document.createElement('div');
        div.className = `p-2 border-2 rounded-xl text-center cursor-pointer text-xs ${isSelected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100'}`;
        div.innerHTML = `<div class="text-lg">${FLAGS[code].split(' ')[0]}</div><div class="font-bold">${code}</div>`;
        div.onclick = () => {
            if(code === 'TWD') return;
            const idx = DEFAULT_CURRENCIES.indexOf(code);
            if(idx === -1) {
                DEFAULT_CURRENCIES[1] = code; // ç°¡å–®æ›¿æ›
                toast(`Currency swapped to ${code}`);
            }
            renderModalCurrencies();
            renderCurrencySelectors();
        };
        list.appendChild(div);
      });
    }

    function handleMemory(action){
      calculate(true);
      const currentTwd = lastValue * (exchangeRates[currentCurrency] || 1);
      if(action==='add') memoryValue += currentTwd;
      else if(action==='subtract') memoryValue -= currentTwd;
      else if(action==='clear') memoryValue = 0;
      else if(action==='recall') {
          lastValue = memoryValue / (exchangeRates[currentCurrency] || 1);
          expression = String(lastValue);
      }
      toast('Memory Updated');
      updateDisplay();
    }

    function toast(msg){
        const t = document.createElement('div');
        t.className = "fixed top-10 bg-black/80 text-white px-6 py-2 rounded-full text-xs font-bold z-[200] animate-bounce";
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 2000);
    }

    window.onload = () => {
        fetchRates();
        const savedSkin = localStorage.getItem('user-skin-choice') || 'default';
        changeSkin(savedSkin);
    };
  </script>
</body>
</html>
