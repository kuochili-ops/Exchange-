<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚åŒ¯ç‡è¨ˆç®—æ©Ÿ</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­ç½®å…¨å±€å­—é«”å’ŒèƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* æ ¸å¿ƒï¼šå¼·åˆ¶è¨ˆç®—æ©ŸæŒ‰éˆ• 4 æ¬„ä½ˆå±€ */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px; /* æŒ‰éˆ•é–“è· */
        }

        /* è®“æŒ‰éˆ•åœ¨å°è¢å¹•ä¸Šä¿æŒè¶³å¤ çš„é»æ“Šå€åŸŸ */
        .calc-button {
            padding: 1rem 0.5rem;
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            transition: transform 0.1s;
            cursor: pointer;
        }

        .calc-button:active {
            transform: scale(0.98);
        }
        
        /* è®“è²¨å¹£é¸æ“‡æŒ‰éˆ• 5 æ¬„ä½ˆå±€ */
        .currency-selector-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        /* è™•ç†çµæœé¡¯ç¤ºå€çš„å­—é«” */
        #display-expression {
            font-size: 0.9rem; /* sm:text-lg */
            color: #6b7280; /* text-gray-500 */
        }
        #display-value {
            font-size: 2.5rem; /* sm:text-5xl */
            font-weight: 800; /* font-extrabold */
        }
        #display-currency-flag {
            font-size: 1.125rem; /* text-lg */
            color: #4b5563; /* text-gray-600 */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-sm bg-white shadow-2xl rounded-xl p-5 md:p-6">
        
        <!-- æ¨™é¡Œèˆ‡æ›´æ–°æ™‚é–“ -->
        <header class="mb-4 text-center">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ’± å³æ™‚åŒ¯ç‡è¨ˆç®—æ©Ÿ</h1>
            <p id="update-status" class="text-xs text-gray-500 mt-1">åŒ¯ç‡è³‡æ–™: è¼‰å…¥ä¸­...</p>
        </header>

        <!-- é¡¯ç¤ºå€åŸŸ -->
        <div class="bg-gray-100 p-4 rounded-lg mb-6 shadow-inner">
            <div id="display-expression" class="text-right h-6 overflow-hidden whitespace-nowrap mb-1"></div>
            <div class="flex justify-between items-end">
                <div id="display-currency-flag" class="mr-2"></div>
                <div id="display-value" class="text-gray-900 text-right overflow-hidden whitespace-nowrap font-mono">0</div>
            </div>
        </div>

        <!-- è²¨å¹£é¸æ“‡å™¨ -->
        <div id="currency-selectors" class="currency-selector-grid mb-6">
            <!-- æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- è¨ˆç®—æ©ŸæŒ‰éµå€åŸŸ -->
        <div class="calculator-grid">
            <!-- è¨˜æ†¶éµ -->
            <button onclick="handleMemory('clear')" class="calc-button bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300">MC</button>
            <button onclick="handleMemory('recall')" class="calc-button bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300">MR</button>
            <button onclick="handleMemory('add')" class="calc-button bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300">M+</button>
            <button onclick="handleMemory('subtract')" class="calc-button bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300">M-</button>

            <!-- ç¬¬ä¸€æ’ï¼šåŠŸèƒ½éµ -->
            <button onclick="handleInput('C')" class="calc-button bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600">C</button>
            <button onclick="handleInput('âŒ«')" class="calc-button bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400">âŒ«</button>
            <button onclick="handleInput('()')" class="calc-button bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400">(</button>
            <button onclick="handleInput('/')" class="calc-button bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600">Ã·</button>

            <!-- ç¬¬äºŒæ’ï¼š7, 8, 9, * -->
            <button onclick="handleInput('7')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">7</button>
            <button onclick="handleInput('8')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">8</button>
            <button onclick="handleInput('9')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">9</button>
            <button onclick="handleInput('*')" class="calc-button bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600">Ã—</button>

            <!-- ç¬¬ä¸‰æ’ï¼š4, 5, 6, - -->
            <button onclick="handleInput('4')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">4</button>
            <button onclick="handleInput('5')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">5</button>
            <button onclick="handleInput('6')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">6</button>
            <button onclick="handleInput('-')" class="calc-button bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600">ï¼</button>

            <!-- ç¬¬å››æ’ï¼š1, 2, 3, + -->
            <button onclick="handleInput('1')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">1</button>
            <button onclick="handleInput('2')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">2</button>
            <button onclick="handleInput('3')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">3</button>
            <button onclick="handleInput('+')" class="calc-button bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600">ï¼‹</button>

            <!-- ç¬¬äº”æ’ï¼š0, ., Â±, = -->
            <button onclick="handleInput('0')" class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">0</button>
            <button onclick="handleInput('.') " class="calc-button bg-gray-50 text-gray-900 rounded-lg shadow-md hover:bg-gray-200">.</button>
            <button onclick="handleInput('+/-')" class="calc-button bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400">Â±</button>
            <button onclick="calculate()" class="calc-button bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600">=</button>
        </div>
    </div>

    <script>
        // å…¨å±€ç‹€æ…‹
        let expression = ''; // é¡¯ç¤ºçš„é‹ç®—å¼
        let lastValue = 0;   // ç•¶å‰é¡¯ç¤ºçš„æ•¸å€¼
        let currentCurrency = 'TWD'; // ç•¶å‰é¸æ“‡çš„å¹£åˆ¥
        let exchangeRates = {}; // å­˜æ”¾ TWD ç‚ºåŸºæº–çš„åŒ¯ç‡ (æ ¼å¼: 1 ç›®æ¨™å¹£åˆ¥ = X TWD)
        let memoryValue = 0;    // è¨˜æ†¶æ•¸å€¼ (ä»¥ TWD ç‚ºåŸºæº–)
        
        // UI å…ƒç´ 
        const displayExpr = document.getElementById('display-expression');
        const displayValue = document.getElementById('display-value');
        const displayFlag = document.getElementById('display-currency-flag');
        const updateStatus = document.getElementById('update-status');
        const currencySelectors = document.getElementById('currency-selectors');

        const FLAGS = {
            "TWD": "ğŸ‡¹ğŸ‡¼ TWD", "USD": "ğŸ‡ºğŸ‡¸ USD", "JPY": "ğŸ‡¯ğŸ‡µ JPY", "EUR": "ğŸ‡ªğŸ‡º EUR", "CNY": "ğŸ‡¨ğŸ‡³ CNY",
            "HKD": "ğŸ‡­ğŸ‡° HKD", "GBP": "ğŸ‡¬ğŸ‡§ GBP", "AUD": "ğŸ‡¦ğŸ‡º AUD", "SGD": "ğŸ‡¸ğŸ‡¬ SGD", "KRW": "ğŸ‡°ğŸ‡· KRW",
            "CAD": "ğŸ‡¨ğŸ‡¦ CAD", "CHF": "ğŸ‡¨ğŸ‡­ CHF", "ZAR": "ğŸ‡¿ğŸ‡¦ ZAR", "SEK": "ğŸ‡¸ğŸ‡ª SEK", "NZD": "ğŸ‡³ğŸ‡¿ NZD",
            "THB": "ğŸ‡¹ğŸ‡­ THB", "PHP": "ğŸ‡µğŸ‡­ PHP", "IDR": "ğŸ‡®ğŸ‡© IDR", "MYR": "ğŸ‡²ğŸ‡¾ MYR"
        };
        
        const DEFAULT_CURRENCIES = ['TWD', 'USD', 'JPY', 'EUR', 'CNY'];
        
        // ----------------------------------------------------
        // I. è³‡æ–™ç²å–èˆ‡åˆå§‹åŒ–
        // ----------------------------------------------------

        // å‚™ç”¨åŒ¯ç‡ (æ ¼å¼: 1 TWD = X ç›®æ¨™å¹£åˆ¥)
        // æ³¨æ„ï¼šé€™è£¡çš„å‚™ç”¨æ•¸æ“šæ ¼å¼èˆ‡ API è¿”å›çš„æ ¼å¼ä¸€è‡´ï¼Œä»¥ä¾¿æ–¼è¨ˆç®—
        const FALLBACK_RATES_API_FORMAT = {
            "TWD": 1, "USD": 0.0307, "JPY": 4.80, "EUR": 0.0285, "CNY": 0.22,
            "HKD": 0.24, "GBP": 0.024, "AUD": 0.046, "SGD": 0.042, "KRW": 39.5,
        };

        /**
         * å¾å…¬é–‹ API ç²å–åŒ¯ç‡ (ä½¿ç”¨ TWD ä½œç‚ºåŸºç¤å¹£åˆ¥)
         * åˆ‡æ›ç‚º open.er-api.com
         */
        async function fetchRates() {
            // ä½¿ç”¨ open.er-api.com ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆ
            const API_URL = 'https://open.er-api.com/v6/latest/TWD'; 
            updateStatus.textContent = 'åŒ¯ç‡è³‡æ–™: é€£ç·šä¸­... (ä½¿ç”¨ open.er-api)';

            let ratesFromAPI = null;

            try {
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    const res = await fetch(API_URL);
                    if (res.ok) {
                        response = res;
                        break;
                    }
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response ? response.status : 'æœªçŸ¥'}`);
                }

                const data = await response.json();
                
                // æª¢æŸ¥ API è¿”å›çš„çµæ§‹ (open.er-api ä½¿ç”¨ result å’Œ rates)
                if (data.result !== 'success' || !data.rates) { 
                    throw new Error('API å›å‚³æ ¼å¼éŒ¯èª¤æˆ–æœå‹™å¤±æ•—');
                }

                ratesFromAPI = data.rates;
                updateStatus.textContent = `åŒ¯ç‡è³‡æ–™: å·²æ›´æ–° (${new Date().toLocaleTimeString('zh-TW')})`;
                
            } catch (error) {
                console.error("Fetch Rates Error:", error);
                // å¤±æ•—ï¼šä½¿ç”¨å‚™ç”¨æ•¸æ“š
                ratesFromAPI = FALLBACK_RATES_API_FORMAT;
                updateStatus.textContent = `åŒ¯ç‡è³‡æ–™: ç¶²è·¯ç²å–å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ•¸æ“š`;
            }

            // èª¿æ•´åŒ¯ç‡æ ¼å¼ï¼šå°‡ (1 TWD = X ç›®æ¨™å¹£åˆ¥) è½‰æ›ç‚º (1 ç›®æ¨™å¹£åˆ¥ = Y TWD)
            // è½‰æ›å…¬å¼ï¼š Y = 1 / X
            
            const convertedRates = { "TWD": 1.0 }; // TWD æ°¸é æ˜¯ 1
            for (const [code, rate] of Object.entries(ratesFromAPI)) {
                if (rate > 0) {
                    convertedRates[code] = 1 / rate; 
                } else {
                    convertedRates[code] = 1.0; // ç„¡æ•ˆåŒ¯ç‡è¨­ç‚º 1
                }
            }
            exchangeRates = convertedRates;
            
            renderCurrencySelectors();
            updateDisplay();
        }

        // ----------------------------------------------------
        // II. æ¸²æŸ“èˆ‡é¡¯ç¤º
        // ----------------------------------------------------

        /** æ ¼å¼åŒ–æ•¸å­—ï¼šåŠ ä¸Šåƒåˆ†ä½ï¼Œä¸¦å»é™¤å°¾éƒ¨ä¸å¿…è¦çš„é›¶ */
        function formatNumber(num) {
            if (isNaN(num) || num === null) return '0';
            let s = num.toFixed(8).replace(/\.?0+$/, '');
            let parts = s.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        }

        /** æ¸²æŸ“é ‚éƒ¨è²¨å¹£é¸æ“‡æŒ‰éˆ• */
        function renderCurrencySelectors() {
            currencySelectors.innerHTML = '';
            DEFAULT_CURRENCIES.forEach(code => {
                const isActive = code === currentCurrency;
                const button = document.createElement('button');
                
                button.textContent = code;
                button.setAttribute('data-currency', code);
                button.className = `p-2 rounded-lg font-semibold text-sm shadow-md transition duration-150 ${
                    isActive ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-indigo-100 hover:text-indigo-700'
                }`;
                button.onclick = () => changeCurrency(code);
                
                currencySelectors.appendChild(button);
            });
        }
        
        /** æ›´æ–°é¡¯ç¤ºé¢æ¿ */
        function updateDisplay() {
            displayExpr.textContent = expression || '';
            // é™åˆ¶é¡¯ç¤ºçš„ä½æ•¸é•·åº¦ï¼Œé¿å…æº¢å‡º
            let displayedValue = lastValue;
            if (String(lastValue).length > 15 && !String(lastValue).includes('.')) {
                // å¦‚æœæ˜¯é•·æ•´æ•¸ï¼Œç”¨ç§‘å­¸è¨˜è™Ÿæˆ– toPrecision è™•ç†
                displayedValue = lastValue.toPrecision(10);
            }
            
            displayValue.textContent = formatNumber(displayedValue);
            displayFlag.textContent = FLAGS[currentCurrency] || currentCurrency;
        }

        // ----------------------------------------------------
        // III. é‚è¼¯è™•ç†
        // ----------------------------------------------------

        /** è™•ç†è¨ˆç®—æ©Ÿè¼¸å…¥ (æ•¸å­—, é‹ç®—ç¬¦, åŠŸèƒ½) */
        function handleInput(input) {
            if (input === 'C') {
                expression = '';
                lastValue = 0;
            } else if (input === 'âŒ«') {
                expression = expression.slice(0, -1);
            } else if (input === '()') {
                 // ç°¡å–®æ‹¬è™Ÿé‚è¼¯
                const lastChar = expression.slice(-1);
                const operators = ['+', '-', '*', '/', '('];

                if (expression === '' || operators.includes(lastChar)) {
                    expression += '(';
                } else {
                    const openCount = (expression.match(/\(/g) || []).length;
                    const closeCount = (expression.match(/\)/g) || []).length;
                    
                    if (openCount > closeCount) {
                        expression += ')';
                    } else {
                        // å¦‚æœå¹³è¡¡äº†ï¼Œå‰‡åŠ ä¸Šä¹˜è™Ÿä¸¦é–‹å§‹æ–°é‹ç®—
                        expression += '*(';
                    }
                }

            } else if (input === '+/-') {
                // å˜—è©¦å°‡æ•´å€‹é‹ç®—å¼å–å
                try {
                    const val = evaluateExpression(expression);
                    if (val !== null && !isNaN(val)) {
                        expression = String(-val);
                        lastValue = -val;
                    }
                } catch {}
            } else {
                 // è™•ç†é‹ç®—ç¬¦é‡è¤‡è¼¸å…¥
                const lastChar = expression.slice(-1);
                const operators = ['+', '*', '/'];
                const isOperator = operators.includes(lastChar);
                const isNewOperator = operators.includes(input);

                if (isOperator && isNewOperator && input !== '-') {
                    // æ›¿æ›é‡è¤‡çš„é‹ç®—ç¬¦
                    expression = expression.slice(0, -1) + input;
                } else {
                    expression += input;
                }
            }
            
            // æ¯æ¬¡è¼¸å…¥å¾Œå˜—è©¦æ›´æ–° lastValueï¼ˆå¦‚æœé‹ç®—å¼æœ‰æ•ˆï¼‰
            calculate(false);
            updateDisplay();
        }
        
        /** åŸ·è¡Œè¨ˆç®— */
        function calculate(updateExpression = true) {
            if (!expression) return;
            try {
                const result = evaluateExpression(expression);
                if (result !== null && !isNaN(result) && isFinite(result)) {
                    lastValue = result;
                    if (updateExpression) {
                        expression = String(result);
                    }
                } else if (isFinite(result) === false) {
                     alert('éŒ¯èª¤: é™¤ä»¥é›¶');
                }
            } catch (e) {
                // å¿½ç•¥é‹ç®—ä¸­çš„æš«æ™‚æ€§éŒ¯èª¤
            }
        }

        /** è™•ç†è¨˜æ†¶é«”æ“ä½œ */
        function handleMemory(action) {
            calculate(true); // åŸ·è¡Œè¨ˆç®—ä¸¦æ›´æ–° expression

            // lastValue * (åŒ¯ç‡)ï¼šå°‡ç•¶å‰å¹£åˆ¥çš„æ•¸å€¼è½‰æ›ç‚º TWD åƒ¹å€¼
            const currentTWD = lastValue * (exchangeRates[currentCurrency] || 1); 

            if (action === 'clear') {
                memoryValue = 0;
                alert('è¨˜æ†¶å·²æ¸…é™¤');
            } else if (action === 'recall') {
                // å¾ TWD æ›å›ç•¶å‰å¹£åˆ¥ï¼š (TWD åƒ¹å€¼) / (åŒ¯ç‡)
                const recalledValue = memoryValue / (exchangeRates[currentCurrency] || 1);
                lastValue = recalledValue;
                expression = String(recalledValue);
                alert(`å·²å›æ†¶æ•¸å€¼`);
            } else if (action === 'add') {
                memoryValue += currentTWD;
                alert('å·²åŠ å…¥è¨˜æ†¶');
            } else if (action === 'subtract') {
                memoryValue -= currentTWD;
                alert('å·²å¾è¨˜æ†¶æ‰£é™¤');
            }
            updateDisplay();
        }

        /** åˆ‡æ›å¹£åˆ¥ */
        function changeCurrency(newCurrency) {
            if (newCurrency === currentCurrency) return;
            
            // åŸ·è¡Œè¨ˆç®—ï¼Œç¢ºä¿ lastValue æ˜¯æœ€æ–°çš„çµæœ
            calculate(true); 

            const prevCurrency = currentCurrency;
            
            // 1. lastValue * prevRate: å¾—åˆ° TWD åƒ¹å€¼
            // 2. (TWD åƒ¹å€¼) / newRate: å¾—åˆ°æ–°å¹£åˆ¥åƒ¹å€¼
            const prevRate = exchangeRates[prevCurrency] || 1;
            const newRate = exchangeRates[newCurrency] || 1;

            if (lastValue !== 0 && prevRate !== 0 && newRate !== 0) {
                const valueInTWD = lastValue * prevRate;
                const newValue = valueInTWD / newRate;
                lastValue = newValue;
                expression = String(newValue);
            }

            currentCurrency = newCurrency;
            
            // å¼·åˆ¶é‡æ–°æ¸²æŸ“æŒ‰éˆ•ç‹€æ…‹
            renderCurrencySelectors();
            updateDisplay();
        }

        /** å®‰å…¨åœ°è©•ä¼°æ•¸å­¸é‹ç®—å¼ */
        function evaluateExpression(expr) {
            if (!expr) return 0;
            // é™åˆ¶é‹ç®—å¼åªèƒ½åŒ…å«æ•¸å­—å’ŒåŸºæœ¬é‹ç®—ç¬¦ã€é»ã€æ‹¬è™Ÿ
            const cleanExpr = expr.replace(/[^-()\d/*+.]/g, '');
            
            try {
                // ä½¿ç”¨ Function æ§‹é€ å‡½æ•¸
                return new Function('return ' + cleanExpr)();
            } catch (e) {
                return null;
            }
        }

        // ----------------------------------------------------
        // IV. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        // ----------------------------------------------------

        window.onload = function() {
            // è¼‰å…¥åˆå§‹åŒ¯ç‡æ•¸æ“š
            fetchRates(); 
        };
        
        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œå› ç‚º Streamlit çš„ alert ä¸æœƒå½ˆå‡º
        function alert(message) {
             // ä½¿ç”¨å›ºå®šåœ¨å³ä¸Šè§’çš„ Toast é€šçŸ¥ä»£æ›¿ç€è¦½å™¨ alert
             const alertBox = document.createElement('div');
             alertBox.className = "fixed top-4 right-4 bg-indigo-600 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-100";
             alertBox.textContent = message;
             document.body.appendChild(alertBox); // é™„åŠ åˆ° body ä»¥ç¢ºä¿åœ¨æœ€ä¸Šå±¤
             
             // æ¼¸éš±ä¸¦ç§»é™¤
             setTimeout(() => {
                 alertBox.style.opacity = '0';
                 setTimeout(() => alertBox.remove(), 300);
             }, 2000);
        }

    </script>
</body>
</html>

